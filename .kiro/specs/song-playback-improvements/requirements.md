# Requirements Document

## Introduction

This feature addresses four improvements to the Song Playback page in LearningSong:

1. **Dual Song Selection UI Fix**: The SongSwitcher component exists but is not displaying because the `songVariations` array is not being populated correctly from the backend. This enhancement ensures both song variations from Suno API are properly stored and displayed.

2. **Timestamp Lyrics Offset Adjustment**: The current timestamped lyrics synchronization shows lyrics late compared to the actual vocal timing. The Suno API provides word-level precision (e.g., `startS: 20.40957`, `endS: 20.66489`), but there may be a consistent offset. This enhancement adds an offset adjustment mechanism.

3. **Song History Access**: Users currently lose access to previously generated songs after navigating away. This enhancement provides a song history feature allowing users to access and replay their previously created songs within the 48-hour retention period.

4. **LRC/CC Subtitle File Export**: Users want to download synchronized lyrics files (LRC format) that can be used with external music players for karaoke-style playback.

## Glossary

- **Song Variation**: One of two songs generated by the Suno API from the same lyrics and style parameters
- **SongSwitcher**: UI component that allows users to toggle between the two generated song variations
- **Timestamp Offset**: A time adjustment (in milliseconds) applied to all word timestamps to compensate for synchronization discrepancies
- **Song History**: A list of previously generated songs belonging to the current user, stored in Firestore with 48-hour TTL
- **Aligned Words**: Word-level timing data from Suno API containing startS (start time in seconds) and endS (end time in seconds)
- **LRC File**: Lyrics file format with timestamps, commonly used by music players for synchronized lyrics display
- **Primary Variation**: The user's selected song version when two variations are available
- **Section Marker**: A non-vocal text element in lyrics that indicates song structure (e.g., `**Verse 1**`, `**Chorus**`, `**Bridge**`), identified by the `**...**` pattern

## Requirements

### Requirement 1: Dual Song Selection UI Display

**User Story:** As a user, I want to see and switch between the two song variations generated by Suno, so that I can choose the version I prefer.

#### Acceptance Criteria

1. WHEN the Suno API completes a generation task THEN the system SHALL extract both song variations from the sunoData array response
2. WHEN storing song generation results THEN the system SHALL save both variations with their audio_url, audio_id, and variation_index to Firestore
3. WHEN loading a song on the playback page THEN the system SHALL retrieve all stored variations from the database
4. WHEN two song variations exist THEN the system SHALL display the SongSwitcher component near the audio player
5. WHEN the user clicks a different variation in the switcher THEN the system SHALL update the audio player to play the selected variation
6. WHEN switching variations THEN the system SHALL fetch and display the timestamped lyrics for the newly selected variation

### Requirement 2: Timestamp Lyrics Offset Adjustment

**User Story:** As a user, I want to adjust the lyrics timing offset, so that the highlighted lyrics match the actual vocal timing in the song.

#### Acceptance Criteria

1. WHEN displaying timestamped lyrics THEN the system SHALL apply a configurable offset to all word timestamps before highlighting
2. WHEN the user adjusts the offset slider THEN the system SHALL immediately update the lyrics highlighting without reloading
3. WHEN the offset is adjusted THEN the system SHALL persist the offset value in local storage for the current song
4. WHEN a user returns to a song THEN the system SHALL restore the previously saved offset value
5. WHEN the offset slider is displayed THEN the system SHALL show the current offset value in milliseconds
6. WHEN the offset range is defined THEN the system SHALL allow adjustments from -2000ms to +2000ms with 50ms increments
7. WHEN the user clicks a reset button THEN the system SHALL reset the offset to 0ms

### Requirement 3: Offset UI Controls

**User Story:** As a user, I want intuitive controls to adjust the lyrics timing, so that I can easily fine-tune the synchronization.

#### Acceptance Criteria

1. WHEN timestamped lyrics are available THEN the system SHALL display an offset adjustment control near the lyrics panel
2. WHEN displaying the offset control THEN the system SHALL show a slider with minus and plus buttons for fine adjustment
3. WHEN the user clicks the minus button THEN the system SHALL decrease the offset by 50ms
4. WHEN the user clicks the plus button THEN the system SHALL increase the offset by 50ms
5. WHEN the user drags the slider THEN the system SHALL update the offset in real-time
6. WHEN the offset control is focused THEN the system SHALL support keyboard input for accessibility

### Requirement 4: Song History List

**User Story:** As a user, I want to see a list of my previously created songs, so that I can access and replay them without regenerating.

#### Acceptance Criteria

1. WHEN a user navigates to the song history page THEN the system SHALL display all songs created by the user within the 48-hour retention period
2. WHEN displaying the song history THEN the system SHALL show song style, creation date, and expiration countdown for each entry
3. WHEN displaying the song history THEN the system SHALL order songs by creation date with newest first
4. WHEN a song in the history is expired THEN the system SHALL remove it from the list
5. WHEN the song history is empty THEN the system SHALL display a message indicating no songs are available

### Requirement 5: Song History Navigation

**User Story:** As a user, I want to easily navigate to my song history, so that I can quickly find and play my previous songs.

#### Acceptance Criteria

1. WHEN viewing any page THEN the system SHALL display a navigation link to the song history
2. WHEN the user clicks on a song in the history THEN the system SHALL navigate to the playback page for that song
3. WHEN navigating to a song from history THEN the system SHALL load the song with the user's previously selected variation
4. WHEN the user is on the playback page THEN the system SHALL provide a link back to the song history

### Requirement 6: Song History API

**User Story:** As a developer, I want a backend API to retrieve user song history, so that the frontend can display the list of previous songs.

#### Acceptance Criteria

1. WHEN the frontend requests song history THEN the system SHALL return all non-expired songs for the authenticated user
2. WHEN returning song history THEN the system SHALL include song_id, style, created_at, expires_at, and lyrics preview for each song
3. WHEN returning song history THEN the system SHALL limit the response to the 20 most recent songs
4. WHEN a user has no songs THEN the system SHALL return an empty array
5. WHEN the request is unauthenticated THEN the system SHALL return a 401 error

### Requirement 7: VTT Subtitle File Generation

**User Story:** As a user, I want the system to generate a VTT subtitle file with line-by-line timestamps, so that I can see lyrics displayed sentence by sentence during playback and click on any line to jump to that position.

#### Acceptance Criteria

1. WHEN the Song Playback page loads THEN the system SHALL retrieve the edited lyrics from the Lyrics Editing page
2. WHEN timestamped lyrics are available from Suno API THEN the system SHALL aggregate word-level timestamps into line-level timestamps
3. WHEN aggregating timestamps THEN the system SHALL use the first word's startS as the line start time and the last word's endS as the line end time
4. WHEN generating line timestamps THEN the system SHALL match each line from the edited lyrics to the corresponding words in the Suno timestamp data
5. WHEN the VTT file is generated THEN the system SHALL format timestamps in standard WebVTT format (HH:MM:SS.mmm)
6. WHEN the VTT file is generated THEN the system SHALL save it for use in the lyrics display component
7. WHEN displaying lyrics THEN the system SHALL highlight the current line based on playback time using the VTT timestamps

### Requirement 8: Clickable Lyrics Navigation

**User Story:** As a user, I want to click on any lyrics line to jump to that position in the song, so that I can easily navigate to specific parts of the song.

#### Acceptance Criteria

1. WHEN displaying line-by-line lyrics THEN the system SHALL make each line clickable
2. WHEN the user clicks on a lyrics line THEN the system SHALL seek the audio player to the start time of that line
3. WHEN the user clicks on a lyrics line THEN the system SHALL update the current line highlight immediately
4. WHEN a line is clickable THEN the system SHALL display a hover effect to indicate interactivity
5. WHEN navigating via click THEN the system SHALL continue playback from the new position if audio was playing

### Requirement 9: Line-Level Lyrics Synchronization

**User Story:** As a user, I want to see lyrics highlighted line by line during playback, so that I can follow along with the song more naturally than word-by-word highlighting.

#### Acceptance Criteria

1. WHEN the audio plays THEN the system SHALL highlight the current line based on the VTT timestamps
2. WHEN the current line changes THEN the system SHALL auto-scroll to keep the current line visible
3. WHEN displaying lyrics THEN the system SHALL show section markers (Verse, Chorus, Bridge) as non-highlighted labels
4. WHEN the playback time is between lines THEN the system SHALL highlight the most recently passed line
5. WHEN the user toggles between word-level and line-level sync THEN the system SHALL switch highlighting modes accordingly

### Requirement 10: VTT File Export

**User Story:** As a user, I want to download the VTT subtitle file, so that I can use it with external video players or for accessibility purposes.

#### Acceptance Criteria

1. WHEN line-level timestamps are available THEN the system SHALL display a download button for the VTT file
2. WHEN the user clicks the download button THEN the system SHALL generate a VTT file with line-level timestamps
3. WHEN generating the VTT file THEN the system SHALL include the WEBVTT header
4. WHEN the VTT file is downloaded THEN the system SHALL name the file using the song style and creation date
5. WHEN line-level timestamps are not available THEN the system SHALL hide the download button

### Requirement 11: Accessibility

**User Story:** As a user with accessibility needs, I want the song history and offset controls to be fully accessible, so that I can use them with assistive technologies.

#### Acceptance Criteria

1. WHEN displaying the offset slider THEN the system SHALL provide ARIA labels describing the control purpose and current value
2. WHEN displaying the song history list THEN the system SHALL use semantic HTML with proper heading hierarchy
3. WHEN navigating the song history THEN the system SHALL support keyboard navigation between items
4. WHEN a song item receives focus THEN the system SHALL display visible focus indicators
5. WHEN the offset value changes THEN the system SHALL announce the new value to screen readers

### Requirement 12: Offset Persistence

**User Story:** As a user, I want my offset adjustments to be remembered per song, so that I don't have to readjust every time I return.

#### Acceptance Criteria

1. WHEN the user adjusts the offset THEN the system SHALL save the offset to local storage keyed by song_id
2. WHEN loading a song THEN the system SHALL check local storage for a saved offset and apply it
3. WHEN the offset storage exceeds 50 entries THEN the system SHALL remove the oldest entries to prevent storage bloat
4. WHEN clearing browser data THEN the system SHALL gracefully handle missing offset values by defaulting to 0ms

### Requirement 13: Section Marker Detection and Handling

**User Story:** As a user, I want section markers (like **Verse**, **Chorus**) to be handled separately from actual lyrics, so that the highlighting accurately follows the vocal timing rather than staying on markers.

#### Acceptance Criteria

1. WHEN processing alignedWords THEN the system SHALL detect words matching the pattern `**...**` as section markers
2. WHEN a section marker is detected THEN the system SHALL classify it as a non-vocal element separate from regular lyrics
3. WHEN displaying section markers THEN the system SHALL render them with distinct visual styling (muted color, smaller font, or label badge)
4. WHEN the current playback time is within a section marker's timestamp range THEN the system SHALL skip highlighting the marker and highlight the next actual lyric word instead
5. WHEN calculating the current word index THEN the system SHALL exclude section markers from the highlighting sequence
6. WHEN a section marker appears THEN the system SHALL display it inline but not apply the "current word" highlight effect to it

### Requirement 14: Section Marker Skip Option

**User Story:** As a user, I want the option to show or hide section markers in the lyrics display, so that I can focus on just the singable lyrics if preferred.

#### Acceptance Criteria

1. WHEN timestamped lyrics contain section markers THEN the system SHALL display a toggle control to show/hide markers
2. WHEN the user toggles markers off THEN the system SHALL hide all `**...**` pattern words from the display
3. WHEN the user toggles markers on THEN the system SHALL show section markers with distinct styling
4. WHEN the marker visibility preference changes THEN the system SHALL persist the preference in local storage
5. WHEN loading the lyrics display THEN the system SHALL restore the user's marker visibility preference

