# E2E Testing Guide for Dual Song Selection Feature

This guide explains how to run and use the E2E tests for the dual song selection feature.

## Overview

The dual song selection E2E tests validate the complete user journey for selecting between two song variations generated by the Suno API. These tests use Chrome DevTools MCP for browser automation and include:

1. **Complete User Journey Test** - Full flow from song generation to variation switching
2. **Keyboard Navigation Test** - Accessibility testing for keyboard users
3. **Mobile Touch Interactions Test** - Responsive design and touch target validation
4. **Offline/Online Transitions Test** - Network state handling and update queueing

## Prerequisites

Before running the E2E tests, ensure you have:

### 1. Chrome Browser with Remote Debugging

Start Chrome with remote debugging enabled:

```bash
# Windows
chrome.exe --remote-debugging-port=9222 --user-data-dir="%TEMP%\chrome-debug"

# macOS
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug

# Linux
google-chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug
```

### 2. Frontend Development Server

Start the frontend dev server:

```bash
cd frontend
pnpm dev
```

The server should be running at `http://localhost:5173`

### 3. Backend Development Server (Optional)

For full integration testing, start the backend:

```bash
cd backend
poetry run uvicorn app.main:app --reload
```

## Running the Tests

### Run All E2E Tests

```bash
cd backend
poetry run pytest tests/test_e2e_dual_song_selection.py -v
```

### Run Specific Test

```bash
# Complete user journey
poetry run pytest tests/test_e2e_dual_song_selection.py::TestDualSongSelectionE2E::test_complete_dual_song_user_journey -v

# Keyboard navigation
poetry run pytest tests/test_e2e_dual_song_selection.py::TestDualSongSelectionE2E::test_keyboard_navigation_flow -v

# Mobile touch interactions
poetry run pytest tests/test_e2e_dual_song_selection.py::TestDualSongSelectionE2E::test_mobile_touch_interactions -v

# Offline/online transitions
poetry run pytest tests/test_e2e_dual_song_selection.py::TestDualSongSelectionE2E::test_offline_online_transitions -v
```

## Test Scenarios

### 1. Complete User Journey Test

**Purpose**: Validates the full dual song selection flow

**Test Steps**:
1. Navigate to song playback page with dual songs
2. Verify song switcher is visible with 2 variations
3. Verify initial variation (0) is active
4. Switch to variation 1
5. Verify audio player updates
6. Verify timestamped lyrics update
7. Verify primary variation is persisted
8. Reload page and verify variation 1 is still active
9. Test playback with variation 1

**Requirements Validated**:
- 1.1-1.5: Dual song extraction and storage
- 2.1-2.5: Song switcher UI visibility
- 3.1-3.6: Variation switching
- 4.1-4.5: Primary variation persistence
- 5.1-5.5: Audio player integration
- 6.1-6.5: Timestamped lyrics integration

### 2. Keyboard Navigation Test

**Purpose**: Validates accessibility for keyboard users

**Test Steps**:
1. Navigate to song playback page
2. Tab to song switcher
3. Verify focus indicator is visible
4. Use arrow keys to navigate between variations
5. Press Enter/Space to activate variation
6. Verify ARIA labels are present
7. Verify screen reader announcements

**Requirements Validated**:
- 9.2: Keyboard navigation support
- 9.3: Focus indicators
- 9.4: Screen reader accessibility

**Keyboard Controls Tested**:
- `Tab` - Navigate to switcher
- `Arrow Left/Right` - Move between variations
- `Enter` or `Space` - Activate selected variation

### 3. Mobile Touch Interactions Test

**Purpose**: Validates responsive design and touch interactions

**Test Steps**:
1. Set mobile viewport (iPhone SE, iPhone 12, iPad Mini, Samsung Galaxy S21)
2. Navigate to song playback page
3. Verify switcher adapts to mobile layout
4. Verify touch targets are â‰¥ 44x44px (WCAG AAA)
5. Simulate touch events on switcher
6. Test landscape orientation

**Requirements Validated**:
- 9.1: Touch-friendly controls
- 9.5: Responsive layout

**Viewports Tested**:
- iPhone SE: 375x667
- iPhone 12: 390x844
- iPad Mini: 768x1024
- Samsung Galaxy S21: 360x800

### 4. Offline/Online Transitions Test

**Purpose**: Validates network state handling

**Test Steps**:
1. Navigate to song playback page
2. Switch variation while online
3. Simulate offline state
4. Attempt to switch variation while offline
5. Verify offline indicator appears
6. Verify update is queued
7. Simulate online state
8. Verify queued update is processed
9. Test rapid offline/online transitions

**Requirements Validated**:
- 4.4: Offline detection
- 8.5: Offline update queueing

## Manual Actions Required

These E2E tests use Chrome DevTools MCP, which requires manual actions to execute browser commands. The tests will print instructions for each step:

### Example Manual Actions:

1. **Connect to Browser**:
   ```
   Use mcp_chrome_devtools_list_pages to see available pages
   Use mcp_chrome_devtools_select_page to select the appropriate page
   ```

2. **Navigate to Page**:
   ```
   Use mcp_chrome_devtools_navigate_page(url='http://localhost:5173/song-playback?taskId=test-task-123')
   ```

3. **Take Screenshot**:
   ```
   Use mcp_chrome_devtools_take_screenshot
   ```

4. **Execute Script**:
   ```
   Use mcp_chrome_devtools_evaluate_script with the provided verification script
   ```

5. **Click Element**:
   ```
   Use mcp_chrome_devtools_click to click the 'Version 2' button
   ```

## Test Artifacts

### Screenshots

Screenshots are automatically captured at key points during test execution and saved to:

```
./report/e2e-chrome-devtools-testing/page-c/
./report/e2e-chrome-devtools-testing/responsive/
```

Screenshot naming convention:
```
{scenario}-{step}-{timestamp}.png
```

Examples:
- `dual-song-journey-01-initial-load-20251201-143022.png`
- `keyboard-nav-01-focus-indicator-20251201-143045.png`
- `mobile-touch-01-iphone-se-initial-20251201-143110.png`

### Test Reports

Test reports are generated in Markdown format:

```
./report/e2e-chrome-devtools-testing/dual-song-journey-report.md
```

Reports include:
- Test summary (passed/failed/skipped)
- Duration
- Screenshots with descriptions
- Error messages (if any)

### Screenshot Index

An HTML index of all screenshots is generated:

```
./report/e2e-chrome-devtools-testing/screenshot-index-{timestamp}.html
```

Open this file in a browser to view all captured screenshots with metadata.

## Verification Scripts

The tests provide JavaScript verification scripts that can be executed in the browser console or via Chrome DevTools MCP. These scripts check:

- Element presence and visibility
- ARIA attributes
- Focus states
- Audio player state
- Network requests
- Local storage/state management

### Example Verification Script:

```javascript
() => {
    const switcher = document.querySelector('[data-testid="song-switcher"]');
    const buttons = switcher?.querySelectorAll('button');
    
    return {
        switcherPresent: switcher !== null,
        buttonCount: buttons?.length || 0,
        activeButton: document.querySelector('[aria-pressed="true"]')?.textContent
    };
}
```

## Troubleshooting

### Chrome Not Connected

**Error**: `Cannot connect to Chrome on port 9222`

**Solution**: 
1. Ensure Chrome is running with `--remote-debugging-port=9222`
2. Check that no other process is using port 9222
3. Try closing all Chrome instances and restarting with the debug flag

### Frontend Server Not Running

**Error**: `Cannot connect to frontend server at http://localhost:5173`

**Solution**:
1. Start the frontend dev server: `cd frontend && pnpm dev`
2. Verify the server is accessible in your browser
3. Check for port conflicts

### Tests Skipped

**Message**: `Prerequisites not met`

**Solution**:
1. Run the prerequisite checks manually:
   ```python
   from tests.e2e_helpers import create_helper
   helper = create_helper()
   success, issues = helper.verify_prerequisites()
   print(issues)
   ```
2. Address each issue listed

### Screenshots Not Captured

**Issue**: Screenshot paths are printed but files don't exist

**Solution**:
1. Ensure you're executing the Chrome DevTools MCP commands
2. Check that the report directory exists and is writable
3. Verify Chrome has permissions to save screenshots

## Best Practices

### 1. Run Tests in Isolation

Run E2E tests separately from unit tests to avoid interference:

```bash
# Run only E2E tests
poetry run pytest tests/test_e2e_dual_song_selection.py -v

# Run all tests except E2E
poetry run pytest tests/ -v -k "not e2e"
```

### 2. Use Fresh Browser Instance

Start Chrome with a clean profile for consistent test results:

```bash
chrome.exe --remote-debugging-port=9222 --user-data-dir="%TEMP%\chrome-debug-$(date +%s)"
```

### 3. Capture Screenshots at Key Points

The tests automatically capture screenshots, but you can add more:

```python
screenshot_path = helper.get_screenshot_path(
    "page-c",
    helper.generate_screenshot_filename("page-c", "my-scenario", "my-step")
)
# Then use mcp_chrome_devtools_take_screenshot to save to screenshot_path
```

### 4. Review Test Reports

After running tests, review the generated reports:

```bash
# Open the HTML screenshot index
start ./report/e2e-chrome-devtools-testing/screenshot-index-*.html

# View the Markdown report
cat ./report/e2e-chrome-devtools-testing/dual-song-journey-report.md
```

## Integration with CI/CD

These E2E tests are designed for manual execution with Chrome DevTools MCP. For automated CI/CD pipelines, consider:

1. **Headless Chrome**: Use `--headless` flag for Chrome
2. **Screenshot Artifacts**: Upload screenshots as CI artifacts
3. **Test Reports**: Parse Markdown reports for CI status
4. **Parallel Execution**: Run different test scenarios in parallel

### Example GitHub Actions Workflow:

```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd backend
          poetry install
      
      - name: Start Chrome with debugging
        run: |
          google-chrome --remote-debugging-port=9222 --headless &
      
      - name: Start frontend server
        run: |
          cd frontend
          pnpm install
          pnpm dev &
      
      - name: Run E2E tests
        run: |
          cd backend
          poetry run pytest tests/test_e2e_dual_song_selection.py -v
      
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: e2e-screenshots
          path: backend/report/e2e-chrome-devtools-testing/
```

## Related Documentation

- [E2E Test Guide](./E2E_TEST_GUIDE.md) - General E2E testing guide
- [E2E Helpers Guide](./E2E_HELPERS_GUIDE.md) - Helper functions documentation
- [Network Mock Guide](./NETWORK_MOCK_GUIDE.md) - Network mocking documentation
- [Dual Song Selection Design](../.kiro/specs/dual-song-selection/design.md) - Feature design document
- [Dual Song Selection Requirements](../.kiro/specs/dual-song-selection/requirements.md) - Feature requirements

## Support

For issues or questions:
1. Check the [E2E Troubleshooting Guide](./E2E_TROUBLESHOOTING_QUICK_REFERENCE.md)
2. Review existing test examples in `test_e2e_user_journey.py`
3. Consult the Chrome DevTools Protocol documentation
