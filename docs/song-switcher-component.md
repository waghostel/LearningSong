# SongSwitcher Component Documentation

This document describes the `SongSwitcher` component, which allows users to switch between two song variations.

**Last Updated:** December 1, 2025  
**Component:** `frontend/src/components/SongSwitcher.tsx`  
**Status:** Implemented

## Overview

The `SongSwitcher` component provides a user-friendly interface for switching between two song variations generated by the Suno API. It displays as a segmented control with "Version 1" and "Version 2" buttons, showing which version is currently active.

### Key Features

- **Segmented Control UI**: Clean, iOS-style toggle between versions
- **Active State Indication**: Visual feedback showing current selection
- **Loading State**: Displays loading indicator during switch operations
- **Keyboard Navigation**: Full keyboard support (Tab, Arrow keys, Enter, Space)
- **Screen Reader Support**: ARIA labels for accessibility
- **Mobile Friendly**: Touch targets ≥ 44x44px
- **Responsive**: Adapts to different screen sizes
- **Conditional Rendering**: Hides when only one variation exists

---

## Component Props

```typescript
interface SongSwitcherProps {
  variations: SongVariation[]
  activeIndex: number
  onSwitch: (index: number) => void
  isLoading?: boolean
  disabled?: boolean
}
```

### Props Description

| Prop | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| `variations` | `SongVariation[]` | Yes | - | Array of song variations (1-2 items) |
| `activeIndex` | `number` | Yes | - | Index of currently active variation (0 or 1) |
| `onSwitch` | `(index: number) => void` | Yes | - | Callback when user switches variations |
| `isLoading` | `boolean` | No | `false` | Whether a switch operation is in progress |
| `disabled` | `boolean` | No | `false` | Whether to disable switching |

### SongVariation Interface

```typescript
interface SongVariation {
  audioUrl: string        // URL to audio file
  audioId: string         // ID for timestamped lyrics
  variationIndex: number  // 0 or 1
}
```

---

## Usage Examples

### Basic Usage

```typescript
import { SongSwitcher } from '@/components/SongSwitcher'

export function PlaybackPage() {
  const [activeIndex, setActiveIndex] = useState(0)
  const [isLoading, setIsLoading] = useState(false)
  
  const variations = [
    {
      audioUrl: 'https://cdn.suno.ai/song_0.mp3',
      audioId: 'audio_id_0',
      variationIndex: 0
    },
    {
      audioUrl: 'https://cdn.suno.ai/song_1.mp3',
      audioId: 'audio_id_1',
      variationIndex: 1
    }
  ]
  
  const handleSwitch = async (index: number) => {
    setIsLoading(true)
    try {
      // Fetch timestamped lyrics for new variation
      await fetchTimestampedLyrics(index)
      
      // Update audio player
      audioPlayer.src = variations[index].audioUrl
      
      // Update primary variation on backend
      await updatePrimaryVariation(index)
      
      setActiveIndex(index)
    } catch (error) {
      console.error('Failed to switch variation:', error)
    } finally {
      setIsLoading(false)
    }
  }
  
  return (
    <SongSwitcher
      variations={variations}
      activeIndex={activeIndex}
      onSwitch={handleSwitch}
      isLoading={isLoading}
    />
  )
}
```

### With useSongSwitcher Hook

```typescript
import { SongSwitcher } from '@/components/SongSwitcher'
import { useSongSwitcher } from '@/hooks/useSongSwitcher'

export function PlaybackPage() {
  const { activeIndex, switchVariation, isLoading, currentVariation } = useSongSwitcher({
    taskId: 'task_abc123',
    variations: songVariations,
    initialIndex: 0,
    onSwitch: (index) => {
      console.log(`Switched to variation ${index}`)
    }
  })
  
  return (
    <SongSwitcher
      variations={songVariations}
      activeIndex={activeIndex}
      onSwitch={switchVariation}
      isLoading={isLoading}
    />
  )
}
```

### Conditional Rendering

```typescript
export function PlaybackPage() {
  const { variations, activeIndex, switchVariation, isLoading } = usePlaybackState()
  
  return (
    <div className="playback-container">
      <AudioPlayer src={variations[activeIndex].audioUrl} />
      
      {/* Only show switcher if 2+ variations exist */}
      {variations.length >= 2 && (
        <SongSwitcher
          variations={variations}
          activeIndex={activeIndex}
          onSwitch={switchVariation}
          isLoading={isLoading}
        />
      )}
    </div>
  )
}
```

### With Error Handling

```typescript
export function PlaybackPage() {
  const [error, setError] = useState<string | null>(null)
  const { activeIndex, switchVariation, isLoading } = useSongSwitcher({
    taskId: 'task_abc123',
    variations: songVariations
  })
  
  const handleSwitch = async (index: number) => {
    try {
      setError(null)
      await switchVariation(index)
    } catch (err) {
      setError('Failed to switch song version. Please try again.')
    }
  }
  
  return (
    <>
      {error && <ErrorToast message={error} />}
      <SongSwitcher
        variations={songVariations}
        activeIndex={activeIndex}
        onSwitch={handleSwitch}
        isLoading={isLoading}
      />
    </>
  )
}
```

---

## Visual Design

### Layout

```
┌─────────────────────────────────┐
│  Version 1  │  Version 2        │
│  (active)   │  (inactive)       │
└─────────────────────────────────┘
```

### States

#### Default State (Inactive)
- Background: Light gray
- Text: Dark gray
- Border: Subtle gray border
- Cursor: Pointer

#### Active State
- Background: Primary color (blue)
- Text: White
- Border: Primary color
- Shadow: Subtle shadow

#### Loading State
- Spinner icon displayed
- Disabled interaction
- Opacity reduced slightly

#### Disabled State
- Background: Very light gray
- Text: Light gray
- Cursor: Not-allowed
- Opacity: 0.5

### Responsive Behavior

**Desktop (≥768px):**
- Full width buttons
- Padding: 12px 24px
- Font size: 16px
- Touch target: 44x44px minimum

**Mobile (<768px):**
- Stacked layout or smaller buttons
- Padding: 10px 16px
- Font size: 14px
- Touch target: 44x44px minimum (enforced)

---

## Accessibility Features

### Keyboard Navigation

| Key | Action |
|-----|--------|
| `Tab` | Move focus to next button |
| `Shift+Tab` | Move focus to previous button |
| `Left Arrow` | Switch to previous variation |
| `Right Arrow` | Switch to next variation |
| `Enter` | Activate focused button |
| `Space` | Activate focused button |

### ARIA Attributes

```html
<div role="group" aria-label="Song version selector">
  <button
    aria-label="Version 1"
    aria-pressed="true"
    aria-current="true"
  >
    Version 1
  </button>
  <button
    aria-label="Version 2"
    aria-pressed="false"
  >
    Version 2
  </button>
</div>
```

### Screen Reader Announcements

- **On Load:** "Song version selector with 2 versions. Version 1 is currently selected."
- **On Switch:** "Version 2 selected. Loading new version..."
- **On Complete:** "Version 2 loaded and ready to play."
- **On Error:** "Failed to switch to version 2. Please try again."

### Focus Indicators

- Visible focus outline (2px solid primary color)
- Minimum contrast ratio: 4.5:1
- Focus visible on keyboard navigation
- No focus visible on mouse click (`:focus-visible`)

---

## Styling

### CSS Classes

```css
/* Container */
.song-switcher {
  display: flex;
  gap: 0;
  border-radius: 8px;
  overflow: hidden;
  background: #f0f0f0;
  padding: 4px;
}

/* Button */
.song-switcher__button {
  flex: 1;
  padding: 12px 24px;
  border: none;
  background: transparent;
  color: #666;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: all 200ms ease;
  border-radius: 6px;
  min-height: 44px;
  min-width: 44px;
}

/* Active Button */
.song-switcher__button[aria-pressed="true"] {
  background: #3b82f6;
  color: white;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

/* Hover State */
.song-switcher__button:hover:not(:disabled) {
  background: #e5e7eb;
}

.song-switcher__button[aria-pressed="true"]:hover {
  background: #2563eb;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
}

/* Focus State */
.song-switcher__button:focus-visible {
  outline: 2px solid #3b82f6;
  outline-offset: 2px;
}

/* Loading State */
.song-switcher__button.is-loading {
  opacity: 0.7;
  cursor: not-allowed;
}

/* Disabled State */
.song-switcher__button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Loading Spinner */
.song-switcher__spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  margin-right: 8px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
```

### TailwindCSS Classes

```typescript
// Container
className="flex gap-0 rounded-lg overflow-hidden bg-gray-100 p-1"

// Button
className="flex-1 px-6 py-3 border-none bg-transparent text-gray-600 font-medium cursor-pointer transition-all rounded-md min-h-11 min-w-11"

// Active Button
className="bg-blue-500 text-white shadow-md"

// Hover
className="hover:bg-gray-200"

// Focus
className="focus-visible:outline-2 focus-visible:outline-blue-500 focus-visible:outline-offset-2"

// Loading
className="opacity-70 cursor-not-allowed"

// Disabled
className="opacity-50 cursor-not-allowed"
```

---

## Implementation Details

### Component Structure

```typescript
export function SongSwitcher({
  variations,
  activeIndex,
  onSwitch,
  isLoading = false,
  disabled = false
}: SongSwitcherProps) {
  // Hide if only one variation
  if (variations.length < 2) {
    return null
  }
  
  return (
    <div
      role="group"
      aria-label="Song version selector"
      className="song-switcher"
    >
      {variations.map((variation, index) => (
        <button
          key={variation.variationIndex}
          onClick={() => onSwitch(index)}
          aria-label={`Version ${index + 1}`}
          aria-pressed={activeIndex === index}
          aria-current={activeIndex === index ? 'true' : undefined}
          disabled={disabled || isLoading}
          className={cn(
            'song-switcher__button',
            activeIndex === index && 'song-switcher__button--active',
            isLoading && 'song-switcher__button--loading'
          )}
        >
          {isLoading && activeIndex === index && (
            <span className="song-switcher__spinner" />
          )}
          Version {index + 1}
        </button>
      ))}
    </div>
  )
}
```

### Keyboard Navigation Implementation

```typescript
const handleKeyDown = (e: React.KeyboardEvent, index: number) => {
  switch (e.key) {
    case 'ArrowLeft':
      e.preventDefault()
      if (index > 0) onSwitch(index - 1)
      break
    case 'ArrowRight':
      e.preventDefault()
      if (index < variations.length - 1) onSwitch(index + 1)
      break
    case 'Enter':
    case ' ':
      e.preventDefault()
      onSwitch(index)
      break
  }
}
```

---

## Testing

### Unit Tests

```typescript
import { render, screen, fireEvent } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { SongSwitcher } from '@/components/SongSwitcher'

describe('SongSwitcher', () => {
  const variations = [
    { audioUrl: 'url1', audioId: 'id1', variationIndex: 0 },
    { audioUrl: 'url2', audioId: 'id2', variationIndex: 1 }
  ]
  
  it('renders with 2 variations', () => {
    const { container } = render(
      <SongSwitcher
        variations={variations}
        activeIndex={0}
        onSwitch={jest.fn()}
      />
    )
    expect(screen.getByText('Version 1')).toBeInTheDocument()
    expect(screen.getByText('Version 2')).toBeInTheDocument()
  })
  
  it('hides with 1 variation', () => {
    const { container } = render(
      <SongSwitcher
        variations={[variations[0]]}
        activeIndex={0}
        onSwitch={jest.fn()}
      />
    )
    expect(container.firstChild).toBeNull()
  })
  
  it('calls onSwitch when button clicked', async () => {
    const onSwitch = jest.fn()
    render(
      <SongSwitcher
        variations={variations}
        activeIndex={0}
        onSwitch={onSwitch}
      />
    )
    
    await userEvent.click(screen.getByText('Version 2'))
    expect(onSwitch).toHaveBeenCalledWith(1)
  })
  
  it('shows loading state', () => {
    render(
      <SongSwitcher
        variations={variations}
        activeIndex={0}
        onSwitch={jest.fn()}
        isLoading={true}
      />
    )
    
    expect(screen.getByRole('button', { name: /Version 1/i })).toBeDisabled()
  })
  
  it('supports keyboard navigation', async () => {
    const onSwitch = jest.fn()
    render(
      <SongSwitcher
        variations={variations}
        activeIndex={0}
        onSwitch={onSwitch}
      />
    )
    
    const button1 = screen.getByRole('button', { name: /Version 1/i })
    button1.focus()
    
    await userEvent.keyboard('{ArrowRight}')
    expect(onSwitch).toHaveBeenCalledWith(1)
  })
})
```

### Accessibility Tests

```typescript
import { axe, toHaveNoViolations } from 'jest-axe'

expect.extend(toHaveNoViolations)

it('has no accessibility violations', async () => {
  const { container } = render(
    <SongSwitcher
      variations={variations}
      activeIndex={0}
      onSwitch={jest.fn()}
    />
  )
  
  const results = await axe(container)
  expect(results).toHaveNoViolations()
})
```

---

## Integration with useSongSwitcher Hook

The `SongSwitcher` component works seamlessly with the `useSongSwitcher` hook:

```typescript
export function PlaybackPage() {
  const { activeIndex, switchVariation, isLoading } = useSongSwitcher({
    taskId: 'task_abc123',
    variations: songVariations
  })
  
  return (
    <SongSwitcher
      variations={songVariations}
      activeIndex={activeIndex}
      onSwitch={switchVariation}
      isLoading={isLoading}
    />
  )
}
```

The hook handles:
- State management
- API calls to update primary variation
- Fetching timestamped lyrics
- Error handling and recovery
- Request cancellation

---

## Performance Considerations

### Memoization

```typescript
export const SongSwitcher = memo(function SongSwitcher({
  variations,
  activeIndex,
  onSwitch,
  isLoading,
  disabled
}: SongSwitcherProps) {
  // Component implementation
})
```

### Callback Optimization

```typescript
const handleSwitch = useCallback((index: number) => {
  onSwitch(index)
}, [onSwitch])
```

---

## Browser Support

- Chrome/Edge: Latest 2 versions
- Firefox: Latest 2 versions
- Safari: Latest 2 versions
- Mobile browsers: iOS Safari 12+, Chrome Android 90+

---

## Troubleshooting

### Component Not Showing

**Issue:** SongSwitcher is not visible

**Solutions:**
1. Check `variations.length >= 2` (component hides with < 2 variations)
2. Verify `variations` prop is passed correctly
3. Check CSS is loaded (no styling applied)

### Keyboard Navigation Not Working

**Issue:** Arrow keys don't switch variations

**Solutions:**
1. Ensure component has focus (click or Tab to focus)
2. Check `disabled` prop is not `true`
3. Verify `onSwitch` callback is defined

### Loading State Stuck

**Issue:** Loading spinner never disappears

**Solutions:**
1. Check `isLoading` prop is being set to `false` after operation
2. Verify error handling in `onSwitch` callback
3. Check browser console for errors

### Accessibility Issues

**Issue:** Screen reader not announcing changes

**Solutions:**
1. Verify ARIA labels are present
2. Check `aria-pressed` attribute updates
3. Use `aria-live` region for status updates

---

## Related Components

- **AudioPlayer**: Plays the selected variation
- **LyricsDisplay**: Shows lyrics for active variation
- **ProgressTracker**: Shows generation progress
- **ErrorBoundary**: Handles component errors

---

## Related Hooks

- **useSongSwitcher**: Manages variation switching logic
- **useLyricsSync**: Syncs lyrics with audio
- **useWebSocket**: Receives real-time updates

---

## Support & Resources

- **Component Code:** `frontend/src/components/SongSwitcher.tsx`
- **Hook Code:** `frontend/src/hooks/useSongSwitcher.ts`
- **Tests:** `frontend/tests/SongSwitcher.test.tsx`
- **Design System:** `frontend/src/components/ui/`

