# Requirements Document

## Introduction

This feature enables users to receive two song variations from a single generation request and switch between them to select their preferred version. The Suno API generates two songs by default for each request, but the current implementation only presents the first song to users. This enhancement will expose both songs, allowing users to compare and choose their favorite.

## Glossary

- **Song Variation**: One of two songs generated by the Suno API from the same lyrics and style parameters
- **Primary Song**: The currently selected/active song that the user is listening to or viewing
- **Song Switcher**: UI component that allows users to toggle between the two generated song variations
- **Generation Task**: A single API request to Suno that produces two song variations
- **Audio ID**: Unique identifier for each song variation used to fetch timestamped lyrics
- **Song Selection**: The user's choice of which song variation to keep as their preferred version

## Requirements

### Requirement 1

**User Story:** As a user, I want to receive two song variations when I generate music, so that I can choose the version that sounds better to me.

#### Acceptance Criteria

1. WHEN the Suno API completes a generation task THEN the system SHALL retrieve both song variations from the response
2. WHEN both song variations are available THEN the system SHALL store both audio URLs and audio IDs in the database
3. WHEN a song generation completes THEN the system SHALL set the first variation as the primary song by default
4. WHEN storing song variations THEN the system SHALL maintain the order returned by the Suno API
5. WHEN either song variation is unavailable THEN the system SHALL store only the available variation and log a warning

### Requirement 2

**User Story:** As a user, I want to see a clear indicator that two song versions are available, so that I know I have options to choose from.

#### Acceptance Criteria

1. WHEN two song variations exist for a generated song THEN the system SHALL display a song switcher component in the UI
2. WHEN only one song variation exists THEN the system SHALL hide the song switcher component
3. WHEN displaying the song switcher THEN the system SHALL show clear labels for "Version 1" and "Version 2"
4. WHEN displaying the song switcher THEN the system SHALL visually indicate which version is currently active
5. WHEN the page loads with a song THEN the system SHALL display the song switcher in a prominent location near the audio player

### Requirement 3

**User Story:** As a user, I want to easily switch between the two song versions, so that I can compare them and decide which one I prefer.

#### Acceptance Criteria

1. WHEN a user clicks on a different song version in the switcher THEN the system SHALL load and play the selected variation
2. WHEN switching between versions THEN the system SHALL preserve the current playback position if possible
3. WHEN switching between versions THEN the system SHALL update the audio player source to the new song URL
4. WHEN switching between versions THEN the system SHALL fetch timestamped lyrics for the newly selected variation
5. WHEN a switch operation is in progress THEN the system SHALL display a loading indicator on the switcher
6. WHEN switching fails THEN the system SHALL display an error message and revert to the previous selection

### Requirement 4

**User Story:** As a user, I want my song version preference to be saved, so that when I return to view the song, I see the version I selected.

#### Acceptance Criteria

1. WHEN a user selects a song variation THEN the system SHALL update the database to mark that variation as the primary song
2. WHEN a user returns to view a song THEN the system SHALL display the previously selected variation as the active version
3. WHEN updating the primary song selection THEN the system SHALL maintain both variations in storage
4. WHEN the primary song is updated THEN the system SHALL update the selection within 2 seconds
5. WHEN the database update fails THEN the system SHALL display an error message but allow continued playback

### Requirement 5

**User Story:** As a user, I want the song switcher to work seamlessly with the audio player, so that I have a smooth listening experience.

#### Acceptance Criteria

1. WHEN switching between song versions THEN the system SHALL stop playback of the current version before loading the new version
2. WHEN a song version is loading THEN the system SHALL display the audio player loading state
3. WHEN a new song version loads successfully THEN the system SHALL enable the play button
4. WHEN switching during active playback THEN the system SHALL automatically start playing the new version
5. WHEN switching while paused THEN the system SHALL load the new version but remain paused

### Requirement 6

**User Story:** As a user, I want timestamped lyrics to sync correctly with whichever song version I'm listening to, so that I can follow along accurately.

#### Acceptance Criteria

1. WHEN a user switches to a different song variation THEN the system SHALL fetch timestamped lyrics for that variation using its audio ID
2. WHEN timestamped lyrics are loading THEN the system SHALL display the lyrics panel loading state
3. WHEN timestamped lyrics load successfully THEN the system SHALL synchronize highlighting with the new audio
4. WHEN timestamped lyrics fail to load THEN the system SHALL display the original lyrics without timing synchronization
5. WHEN switching between versions THEN the system SHALL cancel any pending timestamped lyrics requests for the previous version

### Requirement 7

**User Story:** As a developer, I want the backend API to return both song variations, so that the frontend can present them to users.

#### Acceptance Criteria

1. WHEN the backend retrieves task status from Suno API THEN the system SHALL extract all available song variations from the sunoData array
2. WHEN returning song generation status to the frontend THEN the system SHALL include an array of song variations with URLs and audio IDs
3. WHEN a song record is created THEN the system SHALL store both song variation URLs and audio IDs
4. WHEN a song record is retrieved THEN the system SHALL return both variations and indicate which is primary
5. WHEN updating the primary song selection THEN the system SHALL accept a variation index parameter

### Requirement 8

**User Story:** As a developer, I want the system to handle edge cases gracefully, so that users have a reliable experience even when issues occur.

#### Acceptance Criteria

1. WHEN the Suno API returns only one song variation THEN the system SHALL store that single variation and hide the switcher UI
2. WHEN the Suno API returns malformed song data THEN the system SHALL log the error and attempt to extract valid variations
3. WHEN a song variation URL becomes invalid THEN the system SHALL display an error message for that variation only
4. WHEN both song variations fail to load THEN the system SHALL display a comprehensive error message
5. WHEN network connectivity is lost during switching THEN the system SHALL display an offline indicator and queue the selection update

### Requirement 9

**User Story:** As a user, I want the song switcher to be accessible and responsive, so that I can use it on any device.

#### Acceptance Criteria

1. WHEN viewing the song switcher on mobile devices THEN the system SHALL display touch-friendly controls with adequate tap targets
2. WHEN viewing the song switcher on desktop THEN the system SHALL support keyboard navigation between versions
3. WHEN using keyboard navigation THEN the system SHALL provide visual focus indicators on the switcher
4. WHEN using a screen reader THEN the system SHALL announce the current version and available options
5. WHEN the viewport is narrow THEN the system SHALL adapt the switcher layout to fit the available space

### Requirement 10

**User Story:** As a product owner, I want to track which song variations users prefer, so that we can understand user preferences and improve generation quality.

#### Acceptance Criteria

1. WHEN a user switches to a different song variation THEN the system SHALL log the selection event with variation index
2. WHEN a user plays a song variation THEN the system SHALL record which variation was played
3. WHEN storing selection events THEN the system SHALL include timestamps and user context
4. WHEN a song is shared THEN the system SHALL share the user's selected variation
5. WHEN generating analytics THEN the system SHALL aggregate variation preferences across all users
