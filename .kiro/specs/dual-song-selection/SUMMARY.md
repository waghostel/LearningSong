# Dual Song Selection Feature - Spec Summary

## Overview

This spec implements a feature to allow users to receive and switch between two song variations generated by the Suno API. Currently, the Suno API generates 2 songs per request, but the application only uses the first one. This feature exposes both songs to users with a switcher UI component.

## Key Answers to Your Questions

### 1. Can I get both songs?
**YES** ✅ - The Suno API returns both songs in the `sunoData` array. This spec updates the backend to extract and store both variations.

### 2. Can it be forced to generate only one?
**NO** ⚠️ - The Suno API doesn't support single-song generation. This spec handles both songs gracefully and hides the switcher UI when only one is available.

### 3. What API version are we using?
**V4** - Currently configured. The spec maintains V4 but documents that V5 is available for future upgrades (faster, better quality).

## What This Spec Delivers

### User Experience
- Users receive 2 song variations from each generation
- Song switcher UI component to toggle between versions
- Selected version persists across page reloads
- Seamless integration with audio player and timestamped lyrics
- Accessible via keyboard and screen readers

### Technical Implementation
- Backend extracts both songs from Suno API response
- Database stores both variations with primary selection
- New API endpoints for switching and fetching variation-specific lyrics
- Frontend SongSwitcher component with full accessibility
- Comprehensive error handling and offline support
- Analytics tracking for user preferences

## Files Created

1. **`.kiro/specs/dual-song-selection/requirements.md`**
   - 10 user stories with 50 acceptance criteria
   - Covers extraction, storage, UI, persistence, accessibility, and analytics

2. **`.kiro/specs/dual-song-selection/design.md`**
   - Complete architecture with sequence diagrams
   - Data models for backend and frontend
   - 28 correctness properties for testing
   - Comprehensive error handling strategies
   - Testing strategy with property-based tests

3. **`.kiro/specs/dual-song-selection/tasks.md`**
   - 18 main implementation tasks
   - 28 property-based test tasks (all required)
   - Integration and E2E test tasks
   - Documentation tasks

## Implementation Approach

### Phase 1: Backend (Tasks 1-2)
- Update `SunoClient` to extract both songs
- Modify database schema for variations array
- Create new API endpoints

### Phase 2: Frontend Core (Tasks 3-8)
- Update data models
- Create SongSwitcher component
- Implement switching logic
- Integrate with playback UI

### Phase 3: Integration (Tasks 9-12)
- Audio player integration
- Timestamped lyrics sync
- Persistence and error handling
- Analytics tracking

### Phase 4: Polish (Tasks 13-18)
- Edge cases and backward compatibility
- Comprehensive testing
- Documentation

## Key Design Decisions

### 1. Backward Compatibility
Old songs with only `song_url` will be migrated to `variations[0]` on read. The switcher will be hidden for these songs.

### 2. Primary Variation
The first variation (index 0) is the default. Users can switch and their selection persists in the database.

### 3. Error Isolation
If one variation fails to load, the other remains available. Errors are displayed per-variation.

### 4. Offline Support
Primary variation updates are queued when offline and processed when connectivity returns.

### 5. Accessibility First
Full keyboard navigation, ARIA labels, focus indicators, and screen reader support built in from the start.

## Testing Strategy

- **28 Property-Based Tests**: Validate correctness properties across all inputs
- **Unit Tests**: Component and function-level testing
- **Integration Tests**: End-to-end flow testing
- **E2E Tests**: Browser-based user journey testing
- **Accessibility Tests**: WCAG compliance with axe-core

## Next Steps

You can now begin implementation by:

1. Opening `.kiro/specs/dual-song-selection/tasks.md`
2. Clicking "Start task" next to Task 1
3. Following the implementation plan step-by-step

Each task includes:
- Clear objectives
- Requirements references
- Implementation details
- Test specifications

## Estimated Effort

- **Backend**: ~3-4 days
- **Frontend**: ~4-5 days
- **Testing**: ~2-3 days (comprehensive)
- **Total**: ~9-12 days for complete implementation

## Benefits

1. **Better User Experience**: Users get choice between variations
2. **Cost Efficiency**: Use both songs we're already paying for
3. **Data Insights**: Track which variations users prefer
4. **Future Flexibility**: Foundation for A/B testing and personalization
